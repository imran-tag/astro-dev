{% extends "portal/base_offline.html" %}

{% block title %}{{ intervention.business_title }} - Astro Tech{% endblock %}

{% block extra_head %}
<style>
    .modal-enter { animation: fadeIn 0.2s ease-out; }
    .modal-leave { animation: fadeOut 0.2s ease-out; }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    .documents-list {
        scrollbar-width: thin;
        scrollbar-color: #CBD5E0 #EDF2F7;
    }

    .documents-list::-webkit-scrollbar { width: 8px; }
    .documents-list::-webkit-scrollbar-track { background: #EDF2F7; }
    .documents-list::-webkit-scrollbar-thumb {
        background-color: #CBD5E0;
        border-radius: 4px;
    }

    body {
        -webkit-tap-highlight-color: transparent;
        background-color: #f3f4f6;
    }

    .header {
        background-color: #f3f4f6;
        padding: 1rem;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        border-bottom: 1px solid #e5e7eb;
    }

    .main-content {
        padding-top: 60px;
        padding-bottom: 70px;
    }

    .detail-item {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: white;
    }

    .detail-label {
        color: #1f2937;
        font-weight: 500;
    }

    .detail-value {
        color: #6b7280;
        text-align: right;
    }

    .profile-circle {
        width: 80px;
        height: 80px;
        background-color: #14224A;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: bold;
        margin: 1rem auto;
    }

    .action-buttons {
        position: fixed;
        right: 1rem;
        top: 5rem;
        display: flex;
        gap: 0.5rem;
    }

    .action-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        color: white;
    }

    .attachment-button { background-color: #14224A; }
    .calendar-button { background-color: #0096FF; }
    .progress-button { background-color: #FF6B00; }

    .action-button:active {
        opacity: 0.8;
        transform: scale(0.95);
    }

    .back-button {
        padding: 0.5rem;
        color: #14224A;
    }

    .fixed { position: fixed; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    .bg-opacity-50 { --tw-bg-opacity: 0.5; }
    .hidden { display: none; }
    .flex { display: flex; }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="header flex items-center">
    <a href="{% url 'interventions' %}" class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Profile Circle -->
    {% if intervention.status_uid == '5' %}
        <div class="profile-circle" style="background-color: #FF6B00;">
            {{ intervention.business_title|slice:":2"|upper }}
        </div>
    {% else %}
        <div class="profile-circle" style="background-color: #14224A;">
            {{ intervention.business_title|slice:":2"|upper }}
        </div>
    {% endif %}

    <!-- Title -->
    <h1 class="text-center text-xl font-bold text-gray-800 mb-4">
        {{ intervention.business_title }}
    </h1>
    <p class="text-center text-gray-600 mb-6">
        {{ intervention.status }}
    </p>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button onclick="showDocuments()" class="action-button attachment-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
        </button>

        {% if intervention.status_uid == '5' %}
            <a href="{% url 'security_checklist' intervention.uid %}" class="action-button progress-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </a>
        {% else %}
            <button onclick="showConfirmationDialog()" class="action-button calendar-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>
        {% endif %}
    </div>

    <!-- Details List -->
    <div class="mt-4">
        <div class="detail-item">
            <span class="detail-label">Titre</span>
            <span class="detail-value">{{ intervention.uid }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Adresse locataire</span>
            <div class="flex flex-col items-end">
                <div class="flex gap-2">
                    <a href="https://www.google.fr/maps/search/{% if intervention.address %}{{ intervention.address|urlencode }}{% endif %}{% if intervention.city %},+{{ intervention.city|urlencode }}{% endif %}"
                       class="text-blue-500 flex items-center"
                       target="_blank"
                       rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        Google Maps
                    </a>
                    <button onclick="openInWaze('{{ intervention.address }}, {{ intervention.city }}')"
                            class="text-blue-500 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        Waze
                    </button>
                </div>
                <span class="text-gray-600">{{ intervention.address }}{% if intervention.city %}, {{ intervention.city }}{% endif %}</span>
            </div>
        </div>

        <div class="detail-item">
            <span class="detail-label">Ville locataire</span>
            <span class="detail-value">{{ intervention.city }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Date</span>
            <span class="detail-value">{{ intervention.date_time }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Priorité</span>
            <span class="detail-value">{{ intervention.priority }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Type</span>
            <span class="detail-value">{{ intervention.intervention_type }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Immeuble</span>
            <span class="detail-value">{{ intervention.building }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Étage</span>
            <span class="detail-value">{{ intervention.floor }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Appartement</span>
            <span class="detail-value">{{ intervention.tenant_name }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">De</span>
            <span class="detail-value">{{ intervention.time_from }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">A</span>
            <span class="detail-value">{{ intervention.time_to }}</span>
        </div>

        <div class="detail-item">
            <span class="detail-label">Description</span>
            <span class="detail-value">{{ intervention.description }}</span>
        </div>
    </div>
</div>

<!-- Confirmation Dialog -->
<div id="confirmationDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 m-4 max-w-sm w-full">
        <h3 class="text-lg font-bold mb-4">Confirmation</h3>
        <p class="mb-6">Voulez-vous démarrer cette intervention ?</p>
        <div class="flex justify-end gap-4">
            <button onclick="hideConfirmationDialog()"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100">
                Annuler
            </button>
            <button onclick="updateInterventionStatus()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Confirmer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const GOOGLE_MAPS_API_KEY = '{{ google_maps_api_key }}';

    function showDocuments() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white w-11/12 max-w-md rounded-lg shadow-lg overflow-hidden">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold">Documents attachés</h3>
                    <button onclick="closeDocumentsModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="documents-list" class="p-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900"></div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeDocumentsModal();
            }
        });

        fetch('{% url "get_intervention_files" intervention.uid %}')
            .then(response => response.json())
            .then(data => {
                const documentsList = document.getElementById('documents-list');
                if (data.success && data.files && data.files.length > 0) {
                    documentsList.innerHTML = `
                        <div class="grid gap-4">
                            ${data.files.map(file => `
                                <a href="https://astro-tech.fr/astro-ges/${file}"
                                   class="flex items-center p-3 bg-gray-50 rounded hover:bg-gray-100"
                                   target="_blank">
                                    <svg class="w-6 h-6 text-blue-900 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                    </svg>
                                    <span class="text-sm text-gray-700">${file.split('/').pop()}</span>
                                </a>
                            `).join('')}
                        </div>
                    `;
                } else {
                    documentsList.innerHTML = `
                        <div class="text-center text-gray-500">
                            Aucun document attaché
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const documentsList = document.getElementById('documents-list');
                documentsList.innerHTML = `
                    <div class="text-center text-red-500">
                        Erreur lors du chargement des documents
                    </div>
                `;
            });
    }

    function closeDocumentsModal() {
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) {
            modal.remove();
        }
    }

    function showConfirmationDialog() {
        document.getElementById('confirmationDialog').classList.remove('hidden');
        document.getElementById('confirmationDialog').classList.add('flex');
    }

    function hideConfirmationDialog() {
        document.getElementById('confirmationDialog').classList.add('hidden');
        document.getElementById('confirmationDialog').classList.remove('flex');
    }

    function updateInterventionStatus() {
        const confirmButton = document.querySelector('#confirmationDialog button:last-child');
        const originalText = confirmButton.textContent;
        confirmButton.textContent = 'Chargement...';
        confirmButton.disabled = true;

        fetch('/interventions/{{ intervention.uid }}/update_status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'en_cours'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erreur lors de la mise à jour du statut');
                hideConfirmationDialog();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la mise à jour du statut');
            hideConfirmationDialog();
        })
        .finally(() => {
            confirmButton.textContent = originalText;
            confirmButton.disabled = false;
        });
    }

    async function openInWaze(address) {
        try {
            const encodedAddress = encodeURIComponent(address);
            const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${GOOGLE_MAPS_API_KEY}`);
            const data = await response.json();

            if (data.results && data.results[0]) {
                const lat = data.results[0].geometry.location.lat;
                const lng = data.results[0].geometry.location.lng;
                const wazeUrl = `https://www.waze.com/fr/live-map/directions?to=${lat}%2C${lng}`;
                window.open(wazeUrl, '_blank');
            } else {
                console.error('No results found');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}